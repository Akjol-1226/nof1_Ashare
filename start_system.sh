#!/bin/bash
# nof1.AShare å®Œæ•´å¯åŠ¨è„šæœ¬

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ðŸš€ nof1.AShare AIè‚¡ç¥¨äº¤æ˜“ç³»ç»Ÿ - å¯åŠ¨è„šæœ¬"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# è¿›å…¥é¡¹ç›®æ ¹ç›®å½•
cd "$(dirname "$0")"
PROJECT_ROOT=$(pwd)

echo "ðŸ“ é¡¹ç›®ç›®å½•: $PROJECT_ROOT"
echo ""

# ==================== æ­¥éª¤1: æ¸…ç†æ—§è¿›ç¨‹ ====================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ§¹ æ­¥éª¤1: æ¸…ç†æ—§è¿›ç¨‹"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# æ€æ­»åŽç«¯è¿›ç¨‹
pkill -9 -f "python.*main.py" 2>/dev/null || true
sleep 1

# æ€æ­»å‰ç«¯è¿›ç¨‹
pkill -9 -f "next.*3002" 2>/dev/null || true
sleep 1

echo "âœ… æ—§è¿›ç¨‹å·²æ¸…ç†"
echo ""

# ==================== æ­¥éª¤2: å¯åŠ¨åŽç«¯ ====================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ”§ æ­¥éª¤2: å¯åŠ¨åŽç«¯æœåŠ¡ (ç«¯å£8889)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

cd "$PROJECT_ROOT/backend"
python main.py > "$PROJECT_ROOT/logs/backend.log" 2>&1 &
BACKEND_PID=$!

echo "   åŽç«¯è¿›ç¨‹ID: $BACKEND_PID"
echo "   æ—¥å¿—æ–‡ä»¶: logs/backend.log"
echo ""
echo "   ç­‰å¾…åŽç«¯å¯åŠ¨..."

# ç­‰å¾…åŽç«¯å¯åŠ¨ï¼ˆæœ€å¤š30ç§’ï¼‰
for i in {1..30}; do
    if curl -s http://localhost:8889/api/test > /dev/null 2>&1; then
        echo "   âœ… åŽç«¯å¯åŠ¨æˆåŠŸï¼"
        break
    fi
    if [ $i -eq 30 ]; then
        echo "   âŒ åŽç«¯å¯åŠ¨è¶…æ—¶"
        tail -20 "$PROJECT_ROOT/logs/backend.log"
        exit 1
    fi
    sleep 1
done

echo ""

# ==================== æ­¥éª¤3: å¯åŠ¨AIç³»ç»Ÿ ====================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ¤– æ­¥éª¤3: å¯åŠ¨AIäº¤æ˜“ç³»ç»Ÿ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

response=$(curl -s -X POST http://localhost:8889/api/system/start)
if echo "$response" | grep -q '"status":"started"'; then
    echo "   âœ… AIç³»ç»Ÿå¯åŠ¨æˆåŠŸ"
else
    echo "   âŒ AIç³»ç»Ÿå¯åŠ¨å¤±è´¥"
    echo "   é”™è¯¯ä¿¡æ¯: $response"
    exit 1
fi

echo ""

# ==================== æ­¥éª¤4: å¯åŠ¨å‰ç«¯ ====================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸŽ¨ æ­¥éª¤4: å¯åŠ¨å‰ç«¯æœåŠ¡ (ç«¯å£3002)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

cd "$PROJECT_ROOT/frontend"

# æ£€æŸ¥node_modulesæ˜¯å¦å­˜åœ¨
if [ ! -d "node_modules" ]; then
    echo "   ðŸ“¦ é¦–æ¬¡è¿è¡Œï¼Œå®‰è£…ä¾èµ–..."
    npm install
fi

echo "   å¯åŠ¨Next.jså¼€å‘æœåŠ¡å™¨..."
PORT=3002 npm run dev > "$PROJECT_ROOT/logs/frontend.log" 2>&1 &
FRONTEND_PID=$!

echo "   å‰ç«¯è¿›ç¨‹ID: $FRONTEND_PID"
echo "   æ—¥å¿—æ–‡ä»¶: logs/frontend.log"
echo ""
echo "   ç­‰å¾…å‰ç«¯å¯åŠ¨..."

# ç­‰å¾…å‰ç«¯å¯åŠ¨ï¼ˆæœ€å¤š30ç§’ï¼‰
for i in {1..30}; do
    if curl -s http://localhost:3002 > /dev/null 2>&1; then
        echo "   âœ… å‰ç«¯å¯åŠ¨æˆåŠŸï¼"
        break
    fi
    if [ $i -eq 30 ]; then
        echo "   âš ï¸ å‰ç«¯å¯åŠ¨è¶…æ—¶ï¼ˆå¯èƒ½ä»åœ¨ç¼–è¯‘ä¸­ï¼‰"
        break
    fi
    sleep 1
done

echo ""

# ==================== å¯åŠ¨å®Œæˆ ====================
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  âœ… ç³»ç»Ÿå¯åŠ¨å®Œæˆï¼"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ðŸ“Š æœåŠ¡çŠ¶æ€:"
echo "   ðŸ”§ åŽç«¯API:    http://localhost:8889  (PID: $BACKEND_PID)"
echo "   ðŸŽ¨ å‰ç«¯ç•Œé¢:    http://localhost:3002  (PID: $FRONTEND_PID)"
echo ""
echo "ðŸ“ æ—¥å¿—æ–‡ä»¶:"
echo "   åŽç«¯: tail -f $PROJECT_ROOT/logs/backend.log"
echo "   å‰ç«¯: tail -f $PROJECT_ROOT/logs/frontend.log"
echo ""
echo "ðŸ›‘ åœæ­¢æœåŠ¡:"
echo "   kill $BACKEND_PID $FRONTEND_PID"
echo "   æˆ–è¿è¡Œ: ./stop_system.sh"
echo ""
echo "ðŸ’¡ æç¤º:"
echo "   - AIå†³ç­–å‘¨æœŸ: æ¯15åˆ†é’Ÿ"
echo "   - åˆå§‹èµ„é‡‘: æ¯ä¸ªAI Â¥100,000"
echo "   - å¯äº¤æ˜“è‚¡ç¥¨: 6åª (ä¸­å…´é€šè®¯ã€å®å¾·æ—¶ä»£ã€ä¸‰å®‰å…‰ç”µã€æ¯”äºšè¿ªã€å¯’æ­¦çºªã€æ’ç‘žåŒ»è¯)"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# ä¿å­˜PIDsåˆ°æ–‡ä»¶
echo "$BACKEND_PID" > "$PROJECT_ROOT/.backend.pid"
echo "$FRONTEND_PID" > "$PROJECT_ROOT/.frontend.pid"

echo "æŒ‰ Ctrl+C æŸ¥çœ‹å®žæ—¶æ—¥å¿—..."
echo ""

# æ˜¾ç¤ºå®žæ—¶æ—¥å¿—
tail -f "$PROJECT_ROOT/logs/backend.log" "$PROJECT_ROOT/logs/frontend.log"







